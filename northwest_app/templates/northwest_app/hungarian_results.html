{% load custom_filters %}
{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados - Método Húngaro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'northwest_app/style-hungarian.css' %}">
</head>
<body>
    <div class="container mt-4">
        <header class="py-3 mb-4 border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h2 mb-0">
                    <i class="bi bi-bezier2 text-primary"></i>
                    Método Húngaro
                </h1>
                <div>
                    <a href="{% url 'northwest_app:setup' %}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-plus-circle"></i> Nuevo Problema
                    </a>
                    <a href="{% url 'northwest_app:history' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-clock-history"></i> Historial
                    </a>
                </div>
            </div>
        </header>
        
        <!-- Resumen del problema -->
        <div class="card summary-card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0"><i class="bi bi-card-checklist"></i> Resumen del Problema</h3>
                <span class="badge bg-light text-dark">{% if problem.type == 'maximization' %}Maximización{% else %}Minimización{% endif %}</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <h5 class="border-bottom pb-2"><i class="bi bi-info-circle"></i> Información General</h5>
                        <div class="row">
                            <div class="col-md-4">
                                <p><strong>Tipo:</strong> 
                                    <span class="badge {% if problem.type == 'maximization' %}bg-warning{% else %}bg-primary{% endif %}">
                                        {% if problem.type == 'maximization' %}Maximización{% else %}Minimización{% endif %}
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Tamaño:</strong> {{ problem.size }}x{{ problem.size }}</p>
                            </div>
                            <div class="col-md-4">
                                <p><strong>Asignaciones:</strong> {{ problem.size }}</p>
                            </div>
                        </div>
                        {% if problem.type == 'maximization' %}
                        <div class="alert alert-warning mt-2">
                            <i class="bi bi-exclamation-triangle"></i> 
                            <strong>Problema de Maximización:</strong> Se ha convertido a minimización restando cada valor del valor máximo de la matriz.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tabla de datos iniciales -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="h5 mb-0"><i class="bi bi-table"></i> Matriz de Costos Original</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hungarian">
                        <thead>
                            <tr>
                                <th></th>
                                {% for j in range_cols %}
                                <th scope="col">Recursos {{ forloop.counter }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range_rows %}
                            <tr>
                                <th>Entidades {{ forloop.counter }}</th>
                                {% for j in range_cols %}
                                <td>
                                    {{ original_costs|index:i|index:j }}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pasos del método Húngaro -->
        <div class="card steps-card mb-4">
            <div class="card-header bg-primary text-white">
                <h3 class="h5 mb-0"><i class="bi bi-list-ol"></i> Pasos del Método Húngaro</h3>
            </div>
            <div class="card-body">
                <div class="steps-container">
                    <div class="accordion" id="hungarianStepsAccordion">
                        {% for step in steps %}
                        <div class="accordion-item mb-3">
                            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="false" aria-controls="collapse{{ forloop.counter }}">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <div>
                                            <strong>Paso {{ step.step }}:</strong> {{ step.description }}
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            {% if step.row_minima %}
                                            <span class="badge bg-info">Fila min</span>
                                            {% endif %}
                                            {% if step.col_minima %}
                                            <span class="badge bg-info">Col min</span>
                                            {% endif %}
                                            {% if step.num_lines %}
                                            <span class="badge {% if step.num_lines == step.required_lines %}bg-success{% else %}bg-warning{% endif %}">{{ step.num_lines }} / {{ step.required_lines }}</span>
                                            {% endif %}
                                            <small class="text-muted ms-2">Ver detalle</small>
                                        </div>
                                    </div>
                                </button>
                            </h2>
                            <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#hungarianStepsAccordion">
                                <div class="accordion-body">
                                    <!-- Mantener contenido detallado del paso (matrices, líneas, asignación) -->
                                    <div class="mb-2">
                                        {% if step.row_minima %}
                                        <div class="row-minima mb-2">
                                            <strong>Mínimos por fila:</strong>
                                            <div class="d-flex flex-wrap gap-2 mt-1">
                                                {% for min_val in step.row_minima %}
                                                <span class="badge bg-secondary">Fila {{ forloop.counter }}: {{ min_val }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% if step.col_minima %}
                                        <div class="col-minima mb-2">
                                            <strong>Mínimos por columna:</strong>
                                            <div class="d-flex flex-wrap gap-2 mt-1">
                                                {% for min_val in step.col_minima %}
                                                <span class="badge bg-secondary">Col {{ forloop.counter }}: {{ min_val }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>

                                    {% if step.matrix_before and step.matrix_after %}
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Matriz Antes:</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered matrix-table">
                                                    <tbody>
                                                        {% for i in range_rows %}
                                                        <tr class="{% if step.lines_info and i in step.lines_info.horizontal_lines %}horizontal-line{% endif %}">
                                                            {% for j in range_cols %}
                                                            <td class="text-center {% if step.lines_info and j in step.lines_info.vertical_lines %}vertical-line{% endif %} {% if step.lines_info and i in step.lines_info.horizontal_lines and j in step.lines_info.vertical_lines %}intersection{% endif %}">
                                                                {# Paso 1: mostrar a - row_min = result si existe row_minima #}
                                                                {% if step.step == 1 and step.row_minima %}
                                                                    {% with cell=step.matrix_before|index:i|index:j minval=step.row_minima|index:i %}
                                                                        <div class="equation">
                                                                            <span class="eq-left">{{ cell }}</span>
                                                                            <span class="eq-op">-</span>
                                                                            <span class="eq-min">{{ minval }}</span>
                                                                            <span class="eq-equals">=</span>
                                                                            <span class="eq-result">{{ cell|sub:minval }}</span>
                                                                        </div>
                                                                    {% endwith %}
                                                                {% elif step.step == 2 and step.col_minima %}
                                                                    {# Para columna: usar col_minima[j] #}
                                                                    {% with cell=step.matrix_before|index:i|index:j minval=step.col_minima|index:j %}
                                                                        <div class="equation">
                                                                            <span class="eq-left">{{ cell }}</span>
                                                                            <span class="eq-op">-</span>
                                                                            <span class="eq-min">{{ minval }}</span>
                                                                            <span class="eq-equals">=</span>
                                                                            <span class="eq-result">{{ cell|sub:minval }}</span>
                                                                        </div>
                                                                    {% endwith %}
                                                                {% else %}
                                                                    {{ step.matrix_before|index:i|index:j }}
                                                                {% endif %}
                                                            </td>
                                                            {% endfor %}
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Matriz Después:</h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered">
                                                    <tbody>
                                                        {% for row in step.matrix_after %}
                                                        <tr>
                                                            {% for cell in row %}
                                                            <td class="text-center {% if cell == 0 %}zero-cell{% endif %}">{{ cell }}</td>
                                                            {% endfor %}
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    {% elif step.matrix %}
                                    <div class="matrix-step">
                                        <h6>Matriz:</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <tbody>
                                                    {% for row in step.matrix %}
                                                    <tr>
                                                        {% for cell in row %}
                                                        <td class="text-center {% if cell == 0 %}zero-cell{% endif %}">{{ cell }}</td>
                                                        {% endfor %}
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if step.lines_info %}
                                    <div class="coverage-info mt-3 p-2 bg-light rounded">
                                        <strong>Filas cubiertas:</strong>
                                        {% for row in step.lines_info.horizontal_lines %}
                                        <span class="badge bg-warning me-1">Fila {{ row|add:1 }}</span>
                                        {% endfor %}
                                        &nbsp; <strong>Columnas cubiertas:</strong>
                                        {% for col in step.lines_info.vertical_lines %}
                                        <span class="badge bg-info me-1">Col {{ col|add:1 }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    {% if step.assignment %}
                                    <div class="assignment-info mt-3">
                                        <strong>Asignación actual:</strong>
                                        <div class="d-flex flex-wrap gap-2 mt-2">
                                            {% for assign in step.assignment %}
                                            <span class="badge bg-success">P{{ assign.0|add:1 }} → T{{ assign.1|add:1 }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if step.min_uncovered_value %}
                                    <div class="min-value-info mt-3 p-2 bg-danger text-white rounded">
                                        <strong>Valor mínimo no cubierto:</strong>
                                        <span class="badge bg-light text-dark ms-2">{{ step.min_uncovered_value }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
                
                <div class="assignment-details mt-4">
                    <h5>Asignaciones Óptimas:</h5>
                    <div class="d-flex flex-wrap gap-3">
                        {% for assign in assignment %}
                        <div class="assignment-item p-3 border rounded">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-check text-success me-2"></i>
                                <div>
                                    <strong>Persona {{ assign.0|add:1 }}</strong> → 
                                    <strong>Tarea {{ assign.1|add:1 }}</strong>
                                    <br>
                                    <small class="text-muted">Costo: {{ original_costs|index:assign.0|index:assign.1 }}</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="total-cost-box mt-4 text-center">
                    <h4 class="mb-1">Costo Total {% if problem.type == 'maximization' %}Máximo{% else %}Mínimo{% endif %}</h4>
                    <h2 class="display-4 fw-bold text-success">${{ total_cost }}</h2>
                </div>
            </div>
        </div>

        <!-- Explicación del método -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h3 class="h5 mb-0"><i class="bi bi-lightbulb"></i> ¿Cómo funciona el Método Húngaro?</h3>
            </div>
            <div class="card-body">
                <p>El método Húngaro es un algoritmo de optimización combinatoria que resuelve el problema de asignación en tiempo polinomial.</p>
                <ul>
                    <li><strong>Paso 1:</strong> Restar el mínimo de cada fila a todos los elementos de la fila</li>
                    <li><strong>Paso 2:</strong> Restar el mínimo de cada columna a todos los elementos de la columna</li>
                    <li><strong>Paso 3:</strong> Cubrir todos los ceros con el mínimo número de líneas</li>
                    <li><strong>Paso 4:</strong> Si el número de líneas es igual al tamaño de la matriz, se ha encontrado la solución óptima</li>
                    <li><strong>Paso 5:</strong> Si no, encontrar el menor elemento no cubierto y ajustar la matriz</li>
                </ul>
                <p class="mb-0">Este método garantiza encontrar la asignación óptima para problemas de asignación cuadrados.</p>
            </div>
        </div>
        
        <footer class="mt-4 pt-3 border-top text-center">
            <p class="text-muted">Método Húngaro - Solución generada el {% now "j F Y H:i" %}</p>
            <div class="btn-group" role="group">
                <a href="{% url 'northwest_app:setup' %}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Resolver otro problema
                </a>
                <a href="{% url 'northwest_app:history' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-clock-history"></i> Ver historial
                </a>
                        <button onclick="window.print()" class="btn btn-outline-primary" aria-label="Imprimir resultados">
                            <i class="bi bi-printer"></i> Imprimir
                        </button>
            </div>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'northwest_app/js/global.js' %}" defer></script>
</body>
</html>